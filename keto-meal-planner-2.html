<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keto Kitchen</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #faf8f4;
    --card: #ffffff;
    --dark: #1a1a18;
    --olive: #4a5240;
    --sage: #7d8c6e;
    --cream: #f0ebe0;
    --accent: #c17f3a;
    --border: #e4ddd0;
    --text: #2c2c28;
    --muted: #9a9486;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Jost', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 48px 24px 80px;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: radial-gradient(circle, #c8bfad 1px, transparent 1px);
    background-size: 28px 28px;
    opacity: 0.22;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 560px;
    display: flex;
    flex-direction: column;
    gap: 36px;
  }

  /* Header */
  .header { text-align: center; }

  .header-eyebrow {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 5px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 10px;
  }

  .header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 46px;
    font-weight: 700;
    color: var(--dark);
    line-height: 1.1;
  }

  .header p {
    margin-top: 12px;
    font-size: 14px;
    font-weight: 300;
    color: var(--muted);
    line-height: 1.7;
  }

  /* Section */
  .section { display: flex; flex-direction: column; gap: 12px; }

  .section-label {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--sage);
  }

  /* Meal type buttons */
  .meal-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }

  .choice-btn {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 14px;
    padding: 18px 10px 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    user-select: none;
    position: relative;
  }

  .choice-btn:hover {
    border-color: var(--sage);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(74,82,64,0.1);
  }

  .choice-btn.selected {
    background: var(--olive);
    border-color: var(--olive);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(74,82,64,0.28);
  }

  .choice-emoji { font-size: 28px; }

  .choice-label {
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.5px;
    color: var(--text);
    transition: color 0.2s;
  }

  .choice-btn.selected .choice-label { color: #fff; }

  .check-dot {
    position: absolute;
    top: 9px; right: 9px;
    width: 16px; height: 16px;
    background: var(--accent);
    border-radius: 50%;
    font-size: 9px;
    color: white;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transform: scale(0);
    transition: all 0.18s;
  }

  .choice-btn.selected .check-dot { opacity: 1; transform: scale(1); }

  /* Ingredient buttons */
  .ing-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .ing-btn {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 14px;
    padding: 16px 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    user-select: none;
    position: relative;
    text-align: left;
  }

  .ing-btn:hover {
    border-color: var(--sage);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(74,82,64,0.1);
  }

  .ing-btn.selected {
    background: var(--olive);
    border-color: var(--olive);
    box-shadow: 0 6px 20px rgba(74,82,64,0.28);
  }

  .ing-emoji { font-size: 32px; flex-shrink: 0; }

  .ing-text { flex: 1; }

  .ing-name {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    transition: color 0.2s;
  }

  .ing-btn.selected .ing-name { color: #fff; }

  .ing-sub {
    font-size: 12px;
    font-weight: 300;
    color: var(--muted);
    margin-top: 3px;
    transition: color 0.2s;
  }

  .ing-btn.selected .ing-sub { color: rgba(255,255,255,0.6); }

  .ing-btn .check-dot { top: 50%; right: 14px; transform: translateY(-50%) scale(0); }
  .ing-btn.selected .check-dot { transform: translateY(-50%) scale(1); opacity: 1; }

  /* Extra ingredients */
  .extra-ing-wrap {
    display: flex;
    flex-direction: column;
    gap: 7px;
    margin-top: 4px;
  }

  .extra-ing-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
    letter-spacing: 0.3px;
  }

  .optional-tag {
    font-size: 10px;
    font-weight: 400;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2px 8px;
  }

  .extra-ing-box {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 10px 14px;
    min-height: 50px;
    display: flex;
    flex-wrap: wrap;
    gap: 7px;
    align-content: flex-start;
    cursor: text;
    transition: border-color 0.2s;
  }

  .extra-ing-box:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(193,127,58,0.1);
  }

  .extra-ing-input {
    border: none;
    outline: none;
    background: transparent;
    font-family: 'Jost', sans-serif;
    font-size: 13px;
    font-weight: 300;
    color: var(--text);
    flex: 1;
    min-width: 180px;
    padding: 2px 0;
  }

  .extra-ing-input::placeholder { color: var(--muted); }

  .extra-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: rgba(193,127,58,0.12);
    border: 1px solid rgba(193,127,58,0.3);
    color: var(--accent);
    border-radius: 6px;
    padding: 3px 10px 3px 10px;
    font-size: 12px;
    font-weight: 500;
    animation: tagPop 0.18s cubic-bezier(0.34,1.56,0.64,1) both;
  }

  @keyframes tagPop {
    from { opacity: 0; transform: scale(0.7); }
    to   { opacity: 1; transform: scale(1); }
  }

  .extra-tag-remove {
    cursor: pointer;
    font-size: 15px;
    line-height: 1;
    opacity: 0.55;
    transition: opacity 0.15s;
    margin-left: 1px;
  }
  .extra-tag-remove:hover { opacity: 1; }

  .extra-ing-hint {
    font-size: 11px;
    color: var(--muted);
    font-weight: 300;
    font-style: italic;
  }

  /* Cuisine style buttons */
  .cuisine-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .cuisine-btn {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 14px;
    padding: 20px 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 14px;
    user-select: none;
    position: relative;
    text-align: left;
  }

  .cuisine-btn:hover {
    border-color: var(--sage);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(74,82,64,0.1);
  }

  .cuisine-btn.selected {
    background: var(--olive);
    border-color: var(--olive);
    box-shadow: 0 6px 20px rgba(74,82,64,0.28);
  }

  .cuisine-emoji { font-size: 30px; flex-shrink: 0; }
  .cuisine-text { flex: 1; }

  .cuisine-name {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    transition: color 0.2s;
  }

  .cuisine-btn.selected .cuisine-name { color: #fff; }

  .cuisine-sub {
    font-size: 11px;
    font-weight: 300;
    color: var(--muted);
    margin-top: 3px;
    line-height: 1.5;
    transition: color 0.2s;
  }

  .cuisine-btn.selected .cuisine-sub { color: rgba(255,255,255,0.6); }

  .cuisine-btn .check-dot { top: 10px; right: 10px; transform: scale(0); }
  .cuisine-btn.selected .check-dot { transform: scale(1); opacity: 1; }

  /* Generate */
  .generate-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .generate-btn {
    width: 100%;
    padding: 18px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 14px;
    font-family: 'Jost', sans-serif;
    font-size: 15px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.22s;
    box-shadow: 0 4px 16px rgba(193,127,58,0.3);
  }

  .generate-btn:hover:not(:disabled) {
    background: #a86c2c;
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(193,127,58,0.4);
  }

  .generate-btn:active:not(:disabled) { transform: translateY(0); }

  .generate-btn:disabled {
    background: #d9d2c8;
    box-shadow: none;
    cursor: not-allowed;
    color: #b0a898;
  }

  .hint {
    font-size: 12px;
    color: var(--muted);
    font-weight: 300;
    text-align: center;
  }

  /* Loading */
  .loading-card {
    background: var(--card);
    border-radius: 20px;
    padding: 48px;
    text-align: center;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    animation: riseIn 0.3s ease both;
  }

  .spinner {
    width: 42px; height: 42px;
    border: 3px solid var(--cream);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.85s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-title {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    color: var(--dark);
  }

  .loading-sub { font-size: 13px; color: var(--muted); font-weight: 300; }

  /* Result */
  .result-card {
    background: var(--card);
    border-radius: 20px;
    overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: 0 12px 48px rgba(0,0,0,0.07);
    animation: riseIn 0.5s cubic-bezier(0.22,1,0.36,1) both;
  }

  @keyframes riseIn {
    from { opacity: 0; transform: translateY(24px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .result-top {
    padding: 28px 28px 24px;
    background: var(--olive);
    color: white;
    position: relative;
    overflow: hidden;
  }

  .result-top::after {
    content: '';
    position: absolute;
    right: -40px; bottom: -40px;
    width: 180px; height: 180px;
    border-radius: 50%;
    background: rgba(255,255,255,0.04);
    pointer-events: none;
  }

  .result-badges {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .badge {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.8);
  }

  .badge.type { background: rgba(193,127,58,0.55); border-color: rgba(193,127,58,0.8); }

  .result-name {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 700;
    line-height: 1.25;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
  }

  .result-desc {
    font-size: 13px;
    font-weight: 300;
    color: rgba(255,255,255,0.68);
    line-height: 1.65;
    position: relative;
    z-index: 1;
  }

  .macros-row {
    display: flex;
    border-bottom: 1px solid var(--border);
  }

  .macro-box {
    flex: 1;
    padding: 14px 6px;
    text-align: center;
    border-right: 1px solid var(--border);
  }
  .macro-box:last-child { border-right: none; }

  .macro-val {
    font-size: 20px;
    font-weight: 500;
    color: var(--accent);
    font-family: 'Playfair Display', serif;
  }

  .macro-lbl {
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 2px;
  }

  .result-body {
    padding: 24px 28px;
    display: flex;
    flex-direction: column;
    gap: 22px;
  }

  .result-section h3 {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    font-weight: 500;
  }

  .ing-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 7px;
  }

  .ing-tag {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 5px 12px;
    font-size: 12px;
    color: var(--text);
  }

  .steps-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .step { display: flex; gap: 14px; align-items: flex-start; }

  .step-num {
    width: 26px; height: 26px; min-width: 26px;
    background: var(--cream);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    font-weight: 500;
    color: var(--olive);
    margin-top: 2px;
  }

  .step p {
    font-size: 13px;
    font-weight: 300;
    line-height: 1.7;
    color: var(--text);
    padding-top: 3px;
  }

  /* Error */
  .error-card {
    background: #fff5f5;
    border: 1px solid #ffd5d5;
    border-radius: 14px;
    padding: 20px 24px;
    text-align: center;
    font-size: 13px;
    color: #c0392b;
  }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="header-eyebrow">Keto Kitchen</div>
    <h1>What are you eating?</h1>
    <p>Pick your meal type and ingredients ‚Äî<br>we'll craft the perfect keto recipe instantly.</p>
  </div>

  <!-- Step 1: Meal Type -->
  <div class="section">
    <div class="section-label">Step 1 ‚Äî Meal Type</div>
    <div class="meal-grid">
      <button class="choice-btn" data-group="meal" data-value="Breakfast" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="choice-emoji">üåÖ</span>
        <span class="choice-label">Breakfast</span>
      </button>
      <button class="choice-btn" data-group="meal" data-value="Lunch" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="choice-emoji">‚òÄÔ∏è</span>
        <span class="choice-label">Lunch</span>
      </button>
      <button class="choice-btn" data-group="meal" data-value="Snack" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="choice-emoji">ü´ô</span>
        <span class="choice-label">Snack</span>
      </button>
      <button class="choice-btn" data-group="meal" data-value="Dinner" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="choice-emoji">üåô</span>
        <span class="choice-label">Dinner</span>
      </button>
    </div>
  </div>

  <!-- Step 2: Ingredients -->
  <div class="section">
    <div class="section-label">Step 2 ‚Äî Main Ingredients</div>
    <div class="ing-grid">
      <button class="ing-btn" data-group="ingredients" data-value="eggs and vegetables" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="ing-emoji">ü•ö</span>
        <div class="ing-text">
          <div class="ing-name">Eggs + Vegetables</div>
          <div class="ing-sub">Spinach, zucchini, peppers, mushrooms</div>
        </div>
      </button>
      <button class="ing-btn" data-group="ingredients" data-value="chicken, eggs and vegetables" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="ing-emoji">üçó</span>
        <div class="ing-text">
          <div class="ing-name">Chicken + Eggs + Vegetables</div>
          <div class="ing-sub">Lean protein with eggs and fresh greens</div>
        </div>
      </button>
      <button class="ing-btn" data-group="ingredients" data-value="meat (beef, lamb or pork)" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="ing-emoji">ü•©</span>
        <div class="ing-text">
          <div class="ing-name">Meat</div>
          <div class="ing-sub">Beef, lamb, or pork ‚Äî rich and satisfying</div>
        </div>
      </button>
    </div>

    <!-- Optional extra ingredients -->
    <div class="extra-ing-wrap">
      <div class="extra-ing-label">
        <span>Ingredients to include</span>
        <span class="optional-tag">Optional</span>
      </div>
      <div class="extra-ing-box" id="extra-ing-box" onclick="document.getElementById('extra-ing-input').focus()">
        <input id="extra-ing-input" class="extra-ing-input" placeholder="e.g. feta cheese, chilli flakes‚Ä¶ press Enter to add" />
      </div>
      <div class="extra-ing-hint">Type an ingredient and press Enter or comma to add as a tag</div>
    </div>
  </div>

  <!-- Step 3: Cuisine Style -->
  <div class="section">
    <div class="section-label">Step 3 ‚Äî Cuisine Style</div>
    <div class="cuisine-grid">
      <button class="cuisine-btn" data-group="cuisine" data-value="Indian-inspired, using spices like cumin, turmeric, coriander, garam masala, mustard seeds, and fresh ginger" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="cuisine-emoji">üáÆüá≥</span>
        <div class="cuisine-text">
          <div class="cuisine-name">Indian Inspired</div>
          <div class="cuisine-sub">Bold spices, aromatic, rich with turmeric & garam masala</div>
        </div>
      </button>
      <button class="cuisine-btn" data-group="cuisine" data-value="non-Indian, using Western or Mediterranean flavors, herbs like rosemary, thyme, oregano, and garlic" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="cuisine-emoji">üåç</span>
        <div class="cuisine-text">
          <div class="cuisine-name">Non-Indian</div>
          <div class="cuisine-sub">Western or Mediterranean herbs & flavors</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Step 4: Portion Size -->
  <div class="section">
    <div class="section-label">Step 4 ‚Äî Portion Size</div>
    <div class="cuisine-grid">
      <button class="cuisine-btn" data-group="portion" data-value="small" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="cuisine-emoji">ü•ó</span>
        <div class="cuisine-text">
          <div class="cuisine-name">Small Meal</div>
          <div class="cuisine-sub">Light &amp; satisfying<br>Under 400 calories</div>
        </div>
      </button>
      <button class="cuisine-btn" data-group="portion" data-value="big" onclick="pick(this)">
        <span class="check-dot">‚úì</span>
        <span class="cuisine-emoji">üçΩÔ∏è</span>
        <div class="cuisine-text">
          <div class="cuisine-name">Big Meal</div>
          <div class="cuisine-sub">Hearty &amp; filling<br>400‚Äì600 calories</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Generate -->
  <div class="generate-wrap">
    <button class="generate-btn" id="gen-btn" disabled onclick="generate()">
      Generate My Meal
    </button>
    <div class="hint" id="hint">Select a meal type and ingredients to continue</div>
  </div>

  <!-- Output -->
  <div id="output"></div>

</div>

<script>
  const sel = { meal: null, ingredients: null, cuisine: null, portion: null };
  const extraIngredients = [];

  // Extra ingredients tag input
  document.addEventListener('DOMContentLoaded', () => {
    const extraInput = document.getElementById('extra-ing-input');
    extraInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        addExtraTag(extraInput.value.replace(',', '').trim());
      } else if (e.key === 'Backspace' && extraInput.value === '' && extraIngredients.length) {
        removeExtraTag(extraIngredients[extraIngredients.length - 1]);
      }
    });
  });

  function addExtraTag(val) {
    if (!val || extraIngredients.includes(val)) return;
    extraIngredients.push(val);
    const box = document.getElementById('extra-ing-box');
    const input = document.getElementById('extra-ing-input');
    const tag = document.createElement('span');
    tag.className = 'extra-tag';
    tag.dataset.val = val;
    tag.innerHTML = val + '<span class="extra-tag-remove" onclick="removeExtraTag(this)">√ó</span>';
    box.insertBefore(tag, input);
    input.value = '';
  }

  function removeExtraTag(btnOrVal) {
    let val, tag;
    if (typeof btnOrVal === 'string') {
      val = btnOrVal;
      tag = document.querySelector(`.extra-tag[data-val="${val}"]`);
    } else {
      tag = btnOrVal.parentElement;
      val = tag.dataset.val;
    }
    const idx = extraIngredients.indexOf(val);
    if (idx > -1) extraIngredients.splice(idx, 1);
    if (tag) tag.remove();
  }

  function pick(btn) {
    const group = btn.dataset.group;
    document.querySelectorAll(`[data-group="${group}"]`).forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    sel[group] = btn.dataset.value;
    sync();
  }

  function sync() {
    const btn = document.getElementById('gen-btn');
    const hint = document.getElementById('hint');
    const allSet = sel.meal && sel.ingredients && sel.cuisine && sel.portion;
    if (allSet) {
      btn.disabled = false;
      const cuisineLabel = sel.cuisine.startsWith('Indian') ? 'Indian Inspired' : 'Non-Indian';
      const portionLabel = sel.portion === 'small' ? 'Under 400 cal' : '400‚Äì600 cal';
      hint.textContent = `Ready!  ${sel.meal}  ¬∑  ${cuisineLabel}  ¬∑  ${portionLabel}`;
    } else if (!sel.meal) {
      hint.textContent = 'Choose your meal type to get started';
    } else if (!sel.ingredients) {
      hint.textContent = 'Now choose your ingredients ‚Üì';
    } else if (!sel.cuisine) {
      hint.textContent = 'Almost there ‚Äî pick a cuisine style ‚Üì';
    } else {
      hint.textContent = 'Last step ‚Äî choose your portion size ‚Üì';
    }
  }

  async function generate() {
    const { meal, ingredients, cuisine, portion } = sel;
    const btn = document.getElementById('gen-btn');
    const output = document.getElementById('output');

    btn.disabled = true;

    const cuisineLabel = cuisine.startsWith('Indian') ? 'Indian Inspired' : 'Non-Indian';
    const extraStr = extraIngredients.length ? extraIngredients.join(', ') : null;
    const isSmall = portion === 'small';
    const calTarget = isSmall ? 'strictly under 400 calories (aim for 250‚Äì380)' : 'between 400 and 600 calories (aim for 450‚Äì580)';
    const calLabel = isSmall ? 'Under 400 cal' : '400‚Äì600 cal';
    const calExample = isSmall ? 320 : 490;
    const fatExample = isSmall ? 22 : 36;
    const protExample = isSmall ? 20 : 32;
    const carbExample = isSmall ? 5 : 7;

    output.innerHTML = `
      <div class="loading-card">
        <div class="spinner"></div>
        <div class="loading-title">Crafting your ${meal}‚Ä¶</div>
        <div class="loading-sub">${cuisineLabel} ¬∑ ${isSmall ? 'Small' : 'Big'} meal ¬∑ ${calLabel}</div>
      </div>`;

    output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    const extraLine = extraStr ? `- Also include these additional ingredients: ${extraStr}` : '';

    const prompt = `You are an expert keto chef. Create ONE keto recipe for ${meal} using ${ingredients} as the main ingredients. The recipe must be ${cuisine}.

CRITICAL CALORIE REQUIREMENT: The total recipe must be ${calTarget}. This is a hard constraint ‚Äî do not exceed it.

Respond ONLY with a raw JSON object ‚Äî no explanation, no markdown, no backticks:
{
  "name": "Recipe Name Here",
  "description": "One appetizing sentence describing this dish.",
  "calories": ${calExample},
  "fat_g": ${fatExample},
  "protein_g": ${protExample},
  "carbs_g": ${carbExample},
  "ingredients": ["2 large eggs", "1 tbsp butter", "60g fresh spinach", "salt and pepper to taste"],
  "steps": [
    "First step here.",
    "Second step here.",
    "Third step here.",
    "Fourth step here.",
    "Fifth step here."
  ]
}

Requirements:
- Strictly keto: low carb, high fat
- Calorie target: ${calTarget}
- Base ingredients must be: ${ingredients}
${extraLine}
- Cuisine style: ${cuisine}
- Recipe must suit a ${meal} context
- 4‚Äì6 ingredients, 4‚Äì6 cooking steps
- Adjust portion sizes in ingredients to hit the calorie target
- Steps must be clear, actionable cooking instructions`;

    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData?.error?.message || `API error ${res.status}`);
      }

      const data = await res.json();
      const raw = data.content?.map(b => b.text || '').join('') || '';
      const match = raw.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Could not parse recipe from response');
      const recipe = JSON.parse(match[0]);
      renderRecipe(recipe, meal, ingredients, cuisineLabel, extraStr, calLabel);
    } catch(err) {
      output.innerHTML = `
        <div class="error-card">
          ‚ö†Ô∏è Something went wrong ‚Äî please try again.<br>
          <small style="opacity:0.6;display:block;margin-top:6px">${err.message}</small>
        </div>`;
    } finally {
      btn.disabled = false;
    }
  }

  // Global safety net ‚Äî prevents the page ever going blank on an unexpected error
  window.addEventListener('error', (e) => {
    const output = document.getElementById('output');
    if (output && output.innerHTML.includes('loading-card')) {
      output.innerHTML = `<div class="error-card">‚ö†Ô∏è Something went wrong ‚Äî please try again.<br><small style="opacity:0.6">${e.message}</small></div>`;
    }
    const btn = document.getElementById('gen-btn');
    if (btn) btn.disabled = false;
  });

  window.addEventListener('unhandledrejection', (e) => {
    const output = document.getElementById('output');
    if (output && output.innerHTML.includes('loading-card')) {
      output.innerHTML = `<div class="error-card">‚ö†Ô∏è Something went wrong ‚Äî please try again.<br><small style="opacity:0.6">${e.reason}</small></div>`;
    }
    const btn = document.getElementById('gen-btn');
    if (btn) btn.disabled = false;
  });

  function renderRecipe(r, meal, ingredients, cuisineLabel, extraStr, calLabel) {
    const output = document.getElementById('output');
    const ingBadge = ingredients.includes('chicken') ? 'Chicken ¬∑ Eggs ¬∑ Veg'
                   : ingredients.includes('eggs') ? 'Eggs ¬∑ Vegetables'
                   : 'Meat';

    output.innerHTML = `
      <div class="result-card">
        <div class="result-top">
          <div class="result-badges">
            <span class="badge type">${meal}</span>
            <span class="badge">${ingBadge}</span>
            <span class="badge">${cuisineLabel}</span>
            <span class="badge">${calLabel}</span>
            ${extraStr ? `<span class="badge" style="background:rgba(193,127,58,0.2);border-color:rgba(193,127,58,0.5);color:var(--accent)">+ ${extraStr}</span>` : ''}
            <span class="badge">Keto</span>
          </div>
          <div class="result-name">${r.name}</div>
          <div class="result-desc">${r.description}</div>
        </div>

        <div class="macros-row">
          <div class="macro-box">
            <div class="macro-val">${r.calories}</div>
            <div class="macro-lbl">Calories</div>
          </div>
          <div class="macro-box">
            <div class="macro-val">${r.fat_g}g</div>
            <div class="macro-lbl">Fat</div>
          </div>
          <div class="macro-box">
            <div class="macro-val">${r.protein_g}g</div>
            <div class="macro-lbl">Protein</div>
          </div>
          <div class="macro-box">
            <div class="macro-val">${r.carbs_g}g</div>
            <div class="macro-lbl">Net Carbs</div>
          </div>
        </div>

        <div class="result-body">
          <div class="result-section">
            <h3>Ingredients</h3>
            <div class="ing-tags">
              ${r.ingredients.map(i => `<span class="ing-tag">${i}</span>`).join('')}
            </div>
          </div>
          <div class="result-section">
            <h3>How to Make It</h3>
            <div class="steps-list">
              ${r.steps.map((s, i) => `
                <div class="step">
                  <div class="step-num">${i + 1}</div>
                  <p>${s}</p>
                </div>`).join('')}
            </div>
          </div>
        </div>
      </div>`;

    output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
</script>
</body>
</html>
